name: Check Suite Verifier

on:
  workflow_run:
    workflows: ["PR Validation 2"]
    types: [completed]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Check Suite Status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Triggered by workflow_run event"
            echo "Workflow Run ID: ${{ github.event.workflow_run.id }}"
            echo "Workflow Name: ${{ github.event.workflow_run.name }}"
            echo "Workflow Status: ${{ github.event.workflow_run.status }}"
            echo "Workflow Conclusion: ${{ github.event.workflow_run.conclusion }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
            echo "Head SHA: $SHA"
            echo "Head Branch: ${{ github.event.workflow_run.head_branch }}"
          else
            echo "Triggered by pull_request event"
            SHA="${{ github.event.pull_request.head.sha }}"
            echo "Head SHA: $SHA"
            echo "Head Branch: ${{ github.head_ref }}"
          fi
          
          echo ""
          echo "Fetching all check runs for commit $SHA..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/commits/$SHA/check-runs" \
            --jq '.check_runs[] | "Check: \(.name) | Status: \(.status) | Conclusion: \(.conclusion)"'
          
          echo ""
          echo "Verification complete"
      
      - name: Wait for all validations to complete
        if: github.event_name == 'workflow_run'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          echo "Waiting for all validation checks to complete for commit $SHA..."
          
          MAX_WAIT=300  # 5 minutes max wait
          ELAPSED=0
          SLEEP_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get status of both validation checks
            VALIDATE_1=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/commits/$SHA/check-runs" \
              --jq '.check_runs[] | select(.name == "validate-1") | .status' | head -1)
            
            VALIDATE_2=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/commits/$SHA/check-runs" \
              --jq '.check_runs[] | select(.name == "validate-2") | .status' | head -1)
            
            echo "validate-1: $VALIDATE_1, validate-2: $VALIDATE_2"
            
            if [ "$VALIDATE_1" = "completed" ] && [ "$VALIDATE_2" = "completed" ]; then
              echo "✓ All validations completed"
              break
            fi
            
            echo "Waiting for validations to complete... (${ELAPSED}s elapsed)"
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "⚠️  Timeout waiting for validations to complete"
            exit 1
          fi
      
      - name: Download Terraform Plans from validate-1
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: terraform-plans-validate-1
          path: downloaded-plans
          workflow: pr-validation-1.yml
          commit: ${{ github.event.workflow_run.head_sha }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Process Terraform Plans
        id: process-plans
        run: |
          echo ""
          echo "Processing Terraform Plans..."
          
          PLAN_HAS_CHANGES=false
          
          if [ -d "downloaded-plans" ] && [ "$(ls -A downloaded-plans)" ]; then
            echo "Found Terraform plans:"
            for plan_file in downloaded-plans/*.json; do
              if [ -f "$plan_file" ]; then
                echo ""
                echo "Plan: $(basename $plan_file)"
                echo "---"
                
                # Check if plan has any resource changes
                CHANGES=$(cat "$plan_file" | jq -r '.resource_changes // [] | length')
                if [ "$CHANGES" -gt 0 ]; then
                  PLAN_HAS_CHANGES=true
                  echo "⚠️  Plan has changes detected"
                  cat "$plan_file" | jq -r '.resource_changes[] | "  Resource: \(.address) | Type: \(.type) | Actions: \(.change.actions | join(", "))"'
                else
                  echo "✓ No changes in this plan"
                fi
              fi
            done
          else
            echo "No Terraform plans found (this is expected on pull_request trigger)"
          fi
          
          echo ""
          if [ "$PLAN_HAS_CHANGES" = "true" ]; then
            echo "❌ Terraform plans contain changes - auto-merge blocked"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "✓ All Terraform plans are clean (no changes)"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "Plan processing complete"
      
      - name: Verify All Checks Passed
        if: github.event_name == 'workflow_run'
        id: verify-checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Verifying all required checks passed..."
          
          SHA="${{ github.event.workflow_run.head_sha }}"
          
          # Get all check runs for the commit
          CHECKS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/commits/$SHA/check-runs" \
            --jq '.check_runs[] | select(.name == "validate-1" or .name == "validate-2") | {name: .name, conclusion: .conclusion}')
          
          echo "$CHECKS"
          
          # Check if any required check failed
          FAILED=$(echo "$CHECKS" | jq -r 'select(.conclusion != "success") | .name' | wc -l)
          
          if [ "$FAILED" -gt 0 ]; then
            echo "❌ Some required checks failed"
            echo "all_passed=false" >> $GITHUB_OUTPUT
          else
            echo "✓ All required checks passed"
            echo "all_passed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-merge Pull Request
        if: |
          github.event_name == 'workflow_run' &&
          github.event.workflow_run.event == 'pull_request' &&
          steps.process-plans.outputs.has_changes == 'false' &&
          steps.verify-checks.outputs.all_passed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "All conditions met for auto-merge:"
          echo "  - No terraform plan changes"
          echo "  - All validation checks passed"
          
          # Find the PR associated with this commit
          PR_NUMBER=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/pulls" \
            --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            echo "Auto-merging PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --squash --auto
            echo "✓ Auto-merge enabled for PR #$PR_NUMBER"
          else
            echo "No open PR found for this commit"
          fi
      
      - name: Report Auto-merge Blocked
        if: |
          github.event_name == 'workflow_run' &&
          github.event.workflow_run.event == 'pull_request' &&
          (steps.process-plans.outputs.has_changes == 'true' || steps.verify-checks.outputs.all_passed == 'false')
        run: |
          echo "⚠️  Auto-merge blocked due to:"
          if [ "${{ steps.process-plans.outputs.has_changes }}" = "true" ]; then
            echo "  - Terraform plans contain changes"
          fi
          if [ "${{ steps.verify-checks.outputs.all_passed }}" = "false" ]; then
            echo "  - Not all validation checks passed"
          fi
          echo ""
          echo "Manual review required"
